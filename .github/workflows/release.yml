name: Release

on:
  push:
    tags:
      - 'v*.*.*'
  workflow_dispatch:
    inputs:
      version:
        description: 'Release version (e.g., v1.0.0)'
        required: true
        type: string

env:
  PYTHON_VERSION: '3.11'
  NODE_VERSION: '18'

jobs:
  # éªŒè¯å‘å¸ƒ
  validate:
    name: Validate Release
    runs-on: ubuntu-latest
    outputs:
      version: ${{ steps.version.outputs.version }}
      is_prerelease: ${{ steps.version.outputs.is_prerelease }}
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            VERSION="${{ github.event.inputs.version }}"
          else
            VERSION=${GITHUB_REF#refs/tags/}
          fi
          
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          
          # æ£€æŸ¥æ˜¯å¦ä¸ºé¢„å‘å¸ƒç‰ˆæœ¬
          if [[ $VERSION =~ -[a-zA-Z] ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
          fi

      - name: Validate version format
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if [[ ! $VERSION =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-[a-zA-Z0-9.-]+)?$ ]]; then
            echo "Invalid version format: $VERSION"
            echo "Expected format: vX.Y.Z or vX.Y.Z-suffix"
            exit 1
          fi

      - name: Check if tag exists
        if: github.event_name == 'workflow_dispatch'
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          if git rev-parse "$VERSION" >/dev/null 2>&1; then
            echo "Tag $VERSION already exists"
            exit 1
          fi

  # è¿è¡Œå®Œæ•´æµ‹è¯•å¥—ä»¶
  test:
    name: Full Test Suite
    runs-on: ubuntu-latest
    needs: validate
    
    strategy:
      matrix:
        python-version: ['3.10', '3.11', '3.12']
        node-version: ['16', '18', '20']
    
    services:
      postgres:
        image: postgres:15
        env:
          POSTGRES_PASSWORD: postgres
          POSTGRES_DB: agentpedia_test
        options: >-
          --health-cmd pg_isready
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 5432:5432

      redis:
        image: redis:7
        options: >-
          --health-cmd "redis-cli ping"
          --health-interval 10s
          --health-timeout 5s
          --health-retries 5
        ports:
          - 6379:6379

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Set up Node.js ${{ matrix.node-version }}
        uses: actions/setup-node@v4
        with:
          node-version: ${{ matrix.node-version }}

      - name: Run full test suite
        env:
          DATABASE_URL: postgresql://postgres:postgres@localhost:5432/agentpedia_test
          REDIS_URL: redis://localhost:6379/0
          ENVIRONMENT: test
        run: |
          chmod +x bootstrap.sh
          ./bootstrap.sh test

  # æ„å»ºå‘å¸ƒåŒ…
  build:
    name: Build Release Packages
    runs-on: ubuntu-latest
    needs: [validate, test]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}

      # æ„å»ºåç«¯åŒ…
      - name: Build backend package
        if: hashFiles('backend/pyproject.toml') != ''
        run: |
          cd backend
          uv sync
          uv build
          
      - name: Upload backend artifacts
        if: hashFiles('backend/pyproject.toml') != ''
        uses: actions/upload-artifact@v3
        with:
          name: backend-dist
          path: backend/dist/

      # æ„å»ºå‰ç«¯åŒ…
      - name: Build frontend package
        if: hashFiles('frontend/package.json') != ''
        run: |
          cd frontend
          npm ci
          npm run build
          
      - name: Upload frontend artifacts
        if: hashFiles('frontend/package.json') != ''
        uses: actions/upload-artifact@v3
        with:
          name: frontend-dist
          path: frontend/dist/

      # åˆ›å»ºå‘å¸ƒåŒ…
      - name: Create release package
        run: |
          mkdir -p release-package
          
          # å¤åˆ¶å¿…è¦æ–‡ä»¶
          cp bootstrap.sh release-package/
          cp README.md release-package/ || echo "README.md not found"
          cp LICENSE release-package/ || echo "LICENSE not found"
          
          # å¤åˆ¶é…ç½®æ–‡ä»¶
          if [ -f "docker-compose.yml" ]; then
            cp docker-compose.yml release-package/
          fi
          
          # åˆ›å»ºç‰ˆæœ¬ä¿¡æ¯æ–‡ä»¶
          echo "${{ needs.validate.outputs.version }}" > release-package/VERSION
          echo "Built on: $(date -u +"%Y-%m-%dT%H:%M:%SZ")" >> release-package/BUILD_INFO
          echo "Commit: ${{ github.sha }}" >> release-package/BUILD_INFO
          
          # æ‰“åŒ…
          tar -czf agentpedia-${{ needs.validate.outputs.version }}.tar.gz -C release-package .
          
      - name: Upload release package
        uses: actions/upload-artifact@v3
        with:
          name: release-package
          path: agentpedia-${{ needs.validate.outputs.version }}.tar.gz

  # å®‰å…¨æ‰«æ
  security-scan:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Run Trivy vulnerability scanner
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'fs'
          scan-ref: '.'
          format: 'sarif'
          output: 'trivy-results.sarif'

      - name: Upload Trivy scan results to GitHub Security tab
        uses: github/codeql-action/upload-sarif@v2
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  # åˆ›å»ºGitHubå‘å¸ƒ
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [validate, test, build, security-scan]
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Download release package
        uses: actions/download-artifact@v3
        with:
          name: release-package

      - name: Download backend artifacts
        if: hashFiles('backend/pyproject.toml') != ''
        uses: actions/download-artifact@v3
        with:
          name: backend-dist
          path: backend-dist/

      - name: Download frontend artifacts
        if: hashFiles('frontend/package.json') != ''
        uses: actions/download-artifact@v3
        with:
          name: frontend-dist
          path: frontend-dist/

      - name: Generate changelog
        id: changelog
        run: |
          # è·å–ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git describe --tags --abbrev=0 HEAD^ 2>/dev/null || echo "")
          
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "## Changes since $PREVIOUS_TAG" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            
            # ç”Ÿæˆæäº¤æ—¥å¿—
            git log --pretty=format:"- %s (%h)" $PREVIOUS_TAG..HEAD >> CHANGELOG.md
          else
            echo "## Initial Release" > CHANGELOG.md
            echo "" >> CHANGELOG.md
            echo "This is the first release of AgentPedia." >> CHANGELOG.md
          fi
          
          # æ·»åŠ å‘å¸ƒä¿¡æ¯
          echo "" >> CHANGELOG.md
          echo "## Release Information" >> CHANGELOG.md
          echo "- **Version**: ${{ needs.validate.outputs.version }}" >> CHANGELOG.md
          echo "- **Build Date**: $(date -u +"%Y-%m-%d %H:%M:%S UTC")" >> CHANGELOG.md
          echo "- **Commit**: ${{ github.sha }}" >> CHANGELOG.md
          
          # è®¾ç½®è¾“å‡º
          echo "changelog<<EOF" >> $GITHUB_OUTPUT
          cat CHANGELOG.md >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Create tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag -a "${{ needs.validate.outputs.version }}" -m "Release ${{ needs.validate.outputs.version }}"
          git push origin "${{ needs.validate.outputs.version }}"

      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ needs.validate.outputs.version }}
          release_name: AgentPedia ${{ needs.validate.outputs.version }}
          body: ${{ steps.changelog.outputs.changelog }}
          draft: false
          prerelease: ${{ needs.validate.outputs.is_prerelease }}

      - name: Upload release assets
        uses: actions/upload-release-asset@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          upload_url: ${{ steps.create_release.outputs.upload_url }}
          asset_path: agentpedia-${{ needs.validate.outputs.version }}.tar.gz
          asset_name: agentpedia-${{ needs.validate.outputs.version }}.tar.gz
          asset_content_type: application/gzip

  # å‘å¸ƒåˆ°åŒ…ç®¡ç†å™¨
  publish:
    name: Publish Packages
    runs-on: ubuntu-latest
    needs: [create-release]
    if: needs.validate.outputs.is_prerelease == 'false'
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: ${{ env.PYTHON_VERSION }}

      - name: Install uv
        run: |
          curl -LsSf https://astral.sh/uv/install.sh | sh
          echo "$HOME/.cargo/bin" >> $GITHUB_PATH

      - name: Set up Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          registry-url: 'https://registry.npmjs.org'

      - name: Download backend artifacts
        if: hashFiles('backend/pyproject.toml') != ''
        uses: actions/download-artifact@v3
        with:
          name: backend-dist
          path: backend/dist/

      - name: Publish to PyPI
        if: hashFiles('backend/pyproject.toml') != ''
        env:
          TWINE_USERNAME: __token__
          TWINE_PASSWORD: ${{ secrets.PYPI_API_TOKEN }}
        run: |
          cd backend
          uv run twine upload dist/*

      - name: Download frontend artifacts
        if: hashFiles('frontend/package.json') != ''
        uses: actions/download-artifact@v3
        with:
          name: frontend-dist
          path: frontend/dist/

      - name: Publish to npm
        if: hashFiles('frontend/package.json') != ''
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
        run: |
          cd frontend
          npm publish

  # éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ
  deploy:
    name: Deploy to Production
    runs-on: ubuntu-latest
    needs: [create-release]
    environment: production
    
    steps:
      - name: Deploy to production
        run: |
          echo "Deploying AgentPedia ${{ needs.validate.outputs.version }} to production"
          # è¿™é‡Œæ·»åŠ ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²é€»è¾‘

  # é€šçŸ¥
  notify:
    name: Release Notification
    runs-on: ubuntu-latest
    needs: [create-release, publish, deploy]
    if: always()
    
    steps:
      - name: Notify on success
        if: needs.create-release.result == 'success'
        run: |
          echo "ğŸ‰ AgentPedia ${{ needs.validate.outputs.version }} has been successfully released!"
          # è¿™é‡Œå¯ä»¥æ·»åŠ æˆåŠŸé€šçŸ¥é€»è¾‘

      - name: Notify on failure
        if: needs.create-release.result == 'failure'
        run: |
          echo "âŒ Release of AgentPedia ${{ needs.validate.outputs.version }} failed!"
          # è¿™é‡Œå¯ä»¥æ·»åŠ å¤±è´¥é€šçŸ¥é€»è¾‘